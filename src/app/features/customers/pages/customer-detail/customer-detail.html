<div class="space-y-10 min-h-screen">

    <!-- LOADING STATE -->
    @if (isLoading()) {
      <div class="flex items-center justify-center py-12">
        <mat-spinner diameter="40"></mat-spinner>
        <p class="ml-4">Cargando detalles del cliente...</p>
      </div>
    }

    <!-- ERROR STATE -->
    @if (error() && !isLoading()) {
      <div class="bg-red-50 border border-red-200 rounded-lg p-4">
        <p class="text-red-800">{{ error().message }}</p>
        <button
          pButton
          label="Reintentar"
          (click)="loadCustomer()"
          class="p-button-sm mt-2">
        </button>
      </div>
    }

    <!-- CUSTOMER DETAILS -->
    @if (customer() && !isLoading() && !error()) {
      <!-- HEADER -->
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-3xl font-bold text-gray-900">{{ customer()!.name }}</h2>
          <p class="text-sm text-gray-500">{{ customer()!.email }}</p>
        </div>
        <button
          (click)="editCustomer()"
          pButton
          label="Editar cliente"
          icon="pi pi-pencil"
          class="p-button-rounded p-button-solid text-sm"
          size="small">
        </button>
      </div>

      <!-- CUSTOMER INFORMATION -->
      <div class="bg-white shadow-md rounded-xl p-6 border border-gray-100">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
          Información del Cliente
        </h3>

        <div class="grid grid-cols-2 gap-4 text-sm">

          <div>
            <span class="block text-xs font-semibold text-gray-500 mb-1">Nombre</span>
            <span class="text-gray-900">{{ customer()!.name }}</span>
          </div>

          <div>
            <span class="block text-xs font-semibold text-gray-500 mb-1">Apellido</span>
            <span class="text-gray-900">{{ customer()!.lastname || '—' }}</span>
          </div>

          <div>
            <span class="block text-xs font-semibold text-gray-500 mb-1">Email</span>
            @if (customer()!.email) {
              <a [href]="'mailto:' + customer()!.email" class="text-indigo-600 hover:text-indigo-800 break-all">
                {{ customer()!.email }}
              </a>
            } @else {
              <span class="text-gray-900">—</span>
            }
          </div>

          <div>
            <span class="block text-xs font-semibold text-gray-500 mb-1">Teléfono</span>
            <app-phone 
              [phone]="customer()!.phone"
              [countryCode]="customer()!.phone_country"
              [countryPhoneCode]="customer()!.phone_code">
            </app-phone>
          </div>

          <div>
            <span class="block text-xs font-semibold text-gray-500 mb-1">Empresa</span>
            <span class="text-gray-900">{{ customer()!.company_name || '—' }}</span>
          </div>

          <div>
            <span class="block text-xs font-semibold text-gray-500 mb-1">Grupo</span>
            <span class="text-gray-900">{{ customer()!.group?.name || '—' }}</span>
          </div>

          <div>
            <span class="block text-xs font-semibold text-gray-500 mb-1">Estado</span>
            <div>
              <p-tag 
                [value]="customer()!.status?.name || customer()!.status_id || 'Desconocido'" 
                [severity]="getSeverity(customer()!.status?.name || customer()!.status_id || '')" 
                rounded="true">
              </p-tag>
            </div>
          </div>

          <div>
            <span class="block text-xs font-semibold text-gray-500 mb-1">Creado</span>
            <span class="text-gray-900">{{ customer()!.created_at | date:'medium' }}</span>
          </div>

          <div class="col-span-2">
            <span class="block text-xs font-semibold text-gray-500 mb-1">Actualizado</span>
            <span class="text-gray-900">{{ customer()!.updated_at | date:'medium' }}</span>
          </div>

        </div>
      </div>

      <!-- CONTRACTS AND PROPERTIES SECTION -->
      <div class="bg-white shadow-md rounded-xl p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-800">
            Propiedades y Contratos
          </h3>
        </div>

        @if (customer()!.contracts && customer()!.contracts.length > 0) {
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Código</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Área</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contrato</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                @for (contract of customer()!.contracts; track contract.id) {
                  <tr class="hover:bg-gray-50 cursor-pointer" (click)="navigateToProperty(contract.property.id)">
                    <td class="px-4 py-3 whitespace-nowrap">
                      <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800">
                        {{ contract.property.code }}
                      </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900">{{ contract.property.name }}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">{{ contract.property.total_area }} m²</td>
                    <td class="px-4 py-3 text-sm text-gray-900">{{ contract.total_price | currency:contract.currency }}</td>
                    <td class="px-4 py-3 whitespace-nowrap">
                      <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800">
                        {{ contract.contract_number }}
                      </span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                            [ngClass]="{
                              'bg-green-100 text-green-800': contract.status === 'activo',
                              'bg-gray-100 text-gray-800': contract.status === 'completado',
                              'bg-red-100 text-red-800': contract.status === 'cancelado'
                            }">
                        {{ contract.status | titlecase }}
                      </span>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        } @else {
          <div class="text-center py-8 text-gray-500">
            <p class="text-sm">No hay contratos asociados</p>
          </div>
        }
      </div>

      <!-- CUSTOMER DOCUMENTS SECTION -->
      <app-customer-documents [customerId]="customer()!.id"></app-customer-documents>

      <!-- ADDRESSES SECTION -->
      <div class="bg-white shadow-md rounded-xl p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-800">
            Direcciones
          </h3>
          <button
            pButton
            icon="pi pi-plus"
            label="Agregar dirección"
            class="p-button-sm p-button-outlined">
          </button>
        </div>

        @if (customer()!.addresses && customer()!.addresses.length > 0) {
          <p-table
            [value]="customer()!.addresses"
            responsiveLayout="scroll"
            styleClass="p-datatable-sm w-full">
            <ng-template pTemplate="header">
              <tr>
                <th>Tipo</th>
                <th>Dirección</th>
                <th>Ciudad</th>
                <th>Estado</th>
                <th>Código postal</th>
                <th>País</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-address>
              <tr>
                <td class="capitalize">{{ address.type }}</td>
                <td>{{ address.street_address }}</td>
                <td>{{ address.city }}</td>
                <td>{{ address.state }}</td>
                <td>{{ address.postal_code }}</td>
                <td>{{ address.country }}</td>
              </tr>
            </ng-template>
          </p-table>
        } @else {
          <div class="text-center py-8 text-gray-500">
            <p class="text-sm">No hay direcciones agregadas</p>
          </div>
        }
      </div>

      <!-- ACTIVITIES SECTION -->
      <div class="bg-white shadow-md rounded-xl p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-800">
            Actividades
          </h3>
          <button
            pButton
            icon="pi pi-plus"
            label="Agregar actividad"
            class="p-button-sm p-button-outlined">
          </button>
        </div>

        @if (customer()!.activities && customer()!.activities.length > 0) {
          <p-table
            [value]="customer()!.activities"
            responsiveLayout="scroll"
            styleClass="p-datatable-sm w-full">
            <ng-template pTemplate="header">
              <tr>
                <th>Tipo</th>
                <th>Título</th>
                <th>Estado</th>
                <th>Fecha de actividad</th>
                <th>Duración</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-activity>
              <tr>
                <td class="capitalize">
                  <p-tag
                    [value]="activity.type"
                    severity="info"
                    rounded="true">
                  </p-tag>
                </td>
                <td>
                  <div class="font-medium text-gray-800">
                    {{ activity.title }}
                  </div>
                  <div class="text-xs text-gray-500">
                    {{ activity.description }}
                  </div>
                </td>
                <td>
                  <p-tag
                    [value]="activity.status"
                    severity="success"
                    rounded="true">
                  </p-tag>
                </td>
                <td>
                  {{ activity.activity_date | date:'medium' }}
                </td>
                <td>
                  {{ activity.duration_minutes }} min
                </td>
              </tr>
            </ng-template>
          </p-table>
        } @else {
          <div class="text-center py-8 text-gray-500">
            <p class="text-sm">No hay actividades agregadas</p>
          </div>
        }
      </div>
    }
</div>