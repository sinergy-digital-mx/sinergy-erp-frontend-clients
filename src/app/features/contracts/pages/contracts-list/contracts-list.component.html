<div class="p-6 bg-white rounded-xl shadow-sm border border-gray-100">
  <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between mb-5">
    <h2 class="text-2xl font-semibold text-gray-800">Contratos</h2>

    <div class="flex items-center gap-3">
      <app-search
        class="w-64"
        [param_activate]="true"
        param_name="search"
        (searchChange)="onSearchChange($event)">
      </app-search>

      <app-button
        text="Crear Contrato"
        custom_class="btn_primary"
        (clicked)="openCreateContractModal()">
      </app-button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div *ngIf="stats()" class="grid grid-cols-4 gap-4 mb-6">
    <!-- Total -->
    <div 
      (click)="applyFilter('total')"
      [class.ring-2]="activeFilter() === 'total'"
      [class.ring-gray-500]="activeFilter() === 'total'"
      class="bg-gradient-to-br from-gray-50 to-gray-100 p-4 rounded-xl border border-gray-200 cursor-pointer hover:shadow-lg transition-all">
      <div class="mb-2">
        <p class="text-xs text-gray-600 font-semibold uppercase tracking-wide mb-0.5">Total</p>
        <p class="text-[10px] text-gray-500">Todos los contratos</p>
      </div>
      <div class="flex items-center justify-between">
        <p class="text-xl font-bold text-gray-900">{{ stats()!.total.value | currency:'USD':'symbol':'1.0-0' }}</p>
        <span class="text-2xl font-bold text-gray-900">{{ stats()!.total.count }}</span>
      </div>
    </div>

    <!-- Completados -->
    <div 
      (click)="applyFilter('completed')"
      [class.ring-2]="activeFilter() === 'completed'"
      [class.ring-blue-500]="activeFilter() === 'completed'"
      class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border border-blue-200 cursor-pointer hover:shadow-lg transition-all">
      <div class="mb-2">
        <p class="text-xs text-blue-600 font-semibold uppercase tracking-wide mb-0.5">Completados</p>
        <p class="text-[10px] text-blue-500">Pagados en su totalidad</p>
      </div>
      <div class="flex items-center justify-between">
        <p class="text-xl font-bold text-blue-900">{{ stats()!.completed.value | currency:'USD':'symbol':'1.0-0' }}</p>
        <span class="text-2xl font-bold text-blue-900">{{ stats()!.completed.count }}</span>
      </div>
    </div>

    <!-- Activos (Pendientes) -->
    <div 
      (click)="applyFilter('pending')"
      [class.ring-2]="activeFilter() === 'pending'"
      [class.ring-green-500]="activeFilter() === 'pending'"
      class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-xl border border-green-200 cursor-pointer hover:shadow-lg transition-all">
      <div class="mb-2">
        <p class="text-xs text-green-600 font-semibold uppercase tracking-wide mb-0.5">Activos</p>
        <p class="text-[10px] text-green-500">En proceso de pago</p>
      </div>
      <div class="flex items-center justify-between mb-2">
        <p class="text-xl font-bold text-green-900">{{ stats()!.pending.value | currency:'USD':'symbol':'1.0-0' }}</p>
        <span class="text-2xl font-bold text-green-900">{{ stats()!.pending.count }}</span>
      </div>
      <div class="flex gap-2 text-xs">
        <span class="text-green-700">Pagado: <strong>{{ stats()!.pending.paid | currency:'USD':'symbol':'1.0-0' }}</strong></span>
        <span class="text-orange-700">Pendiente: <strong>{{ stats()!.pending.remaining | currency:'USD':'symbol':'1.0-0' }}</strong></span>
      </div>
    </div>

    <!-- Vencidos -->
    <div 
      (click)="applyFilter('overdue')"
      [class.ring-2]="activeFilter() === 'overdue'"
      [class.ring-red-500]="activeFilter() === 'overdue'"
      class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-xl border border-red-200 cursor-pointer hover:shadow-lg transition-all">
      <div class="mb-2">
        <p class="text-xs text-red-600 font-semibold uppercase tracking-wide mb-0.5">Vencidos</p>
        <p class="text-[10px] text-red-500">Con pagos atrasados</p>
      </div>
      <div class="flex items-center justify-between">
        <p class="text-xl font-bold text-red-900">{{ stats()!.overdue.value | currency:'USD':'symbol':'1.0-0' }}</p>
        <span class="text-2xl font-bold text-red-900">{{ stats()!.overdue.count }}</span>
      </div>
    </div>
  </div>

  <app-datatable-wrapper
    [config]="table_config()"
    [rowTemplate]="tableTemplate"
    (pageChange)="onPageChange($event)"
    (sortChange)="onSortChange($event)"
    (rowClick)="onRowClick($event)">
  </app-datatable-wrapper>
</div>

<ng-template #tableTemplate let-item="$implicit">
  <td>
    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800 whitespace-nowrap">
      {{ item.contract_number }}
    </span>
  </td>
  <td>
    <span 
      *ngIf="item.customer"
      (click)="navigateToCustomer(item.customer.id); $event.stopPropagation()"
      class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800 cursor-pointer hover:bg-blue-200 transition-colors max-w-[200px] truncate"
      [title]="getCustomerName(item)">
      {{ getCustomerName(item) }}
    </span>
    <span *ngIf="!item.customer" class="text-sm text-gray-400">—</span>
  </td>
  <td>
    <span 
      *ngIf="item.property"
      (click)="navigateToProperty(item.property.id); $event.stopPropagation()"
      class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800 whitespace-nowrap cursor-pointer hover:bg-green-200 transition-colors">
      {{ item.property.code }}
    </span>
    <span *ngIf="!item.property" class="text-sm text-gray-400">—</span>
  </td>
  <td>{{ item.contract_date | date:'mediumDate' }}</td>
  <td>{{ item.total_price | currency:item.currency }}</td>
  <td>{{ item.remaining_balance | currency:item.currency }}</td>
  <td>{{ item.first_payment_date | date:'mediumDate' }}</td>
  <td>
    <span [class]="getStatusClass(item.status)">
      {{ getStatusLabel(item.status) }}
    </span>
  </td>
  <td (click)="$event.stopPropagation()">
    <app-button
      text="Detalle"
      size="sm"
      [fullWidth]="false"
      custom_class="btn_primary"
      (clicked)="viewDetail(item)"
      [icon]="ArrowRight">
    </app-button>
  </td>
</ng-template>
