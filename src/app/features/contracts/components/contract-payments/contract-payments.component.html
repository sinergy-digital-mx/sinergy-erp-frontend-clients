<div class="payments-container">
  <!-- Header -->
  <div class="flex items-center justify-between mb-4">
    <h4 class="text-base font-semibold text-gray-800">Pagos del Contrato</h4>
    <div class="flex gap-2">
      <app-button
        *ngIf="payments().length === 0"
        text="Generar Pagos"
        custom_class="btn_primary"
        size="sm"
        [icon]="Plus"
        [loading]="generating()"
        (clicked)="generatePayments()">
      </app-button>
      <app-button
        *ngIf="payments().length > 0"
        text="Actualizar"
        custom_class="btn_secondary"
        size="sm"
        [icon]="RefreshCw"
        (clicked)="loadPayments(); loadStats()">
      </app-button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div *ngIf="stats()" class="grid grid-cols-4 gap-3 mb-4">
    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
      <p class="text-xs text-blue-600 font-medium">Total Pagos</p>
      <p class="text-lg font-bold text-blue-900">{{ stats()!.total_payments }}</p>
    </div>
    <div class="bg-green-50 p-3 rounded-lg border border-green-200">
      <p class="text-xs text-green-600 font-medium">Pagados</p>
      <p class="text-lg font-bold text-green-900">{{ stats()!.paid_count }}</p>
      <p class="text-xs text-green-700">{{ stats()!.total_paid | currency:currency }}</p>
    </div>
    <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
      <p class="text-xs text-yellow-600 font-medium">Pendientes</p>
      <p class="text-lg font-bold text-yellow-900">{{ stats()!.pending_count }}</p>
      <p class="text-xs text-yellow-700">{{ stats()!.total_pending | currency:currency }}</p>
    </div>
    <div class="bg-red-50 p-3 rounded-lg border border-red-200">
      <p class="text-xs text-red-600 font-medium">Vencidos</p>
      <p class="text-lg font-bold text-red-900">{{ stats()!.overdue_count }}</p>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading()" class="text-center py-8">
    <p class="text-sm text-gray-500">Cargando pagos...</p>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading() && payments().length === 0" class="text-center py-8 text-gray-500">
    <p class="text-sm">No hay pagos generados</p>
  </div>

  <!-- Payments Table -->
  <div *ngIf="!loading() && payments().length > 0" class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">#</th>
          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Monto</th>
          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Vencimiento</th>
          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Fecha Pago</th>
          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Método</th>
          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Referencia</th>
          <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <tr *ngFor="let payment of payments()" class="hover:bg-gray-50">
          <td class="px-3 py-2 text-sm font-medium text-gray-900">{{ payment.payment_number }}</td>
          <td class="px-3 py-2 text-sm text-gray-900">{{ payment.amount | currency:currency }}</td>
          <td class="px-3 py-2 text-sm text-gray-600">{{ payment.due_date | localDate:'mediumDate' }}</td>
          <td class="px-3 py-2 text-sm text-gray-600">{{ payment.paid_date ? (payment.paid_date | localDate:'mediumDate') : '—' }}</td>
          <td class="px-3 py-2">
            <span [class]="getStatusClass(payment.status)">
              {{ getStatusLabel(payment.status) }}
            </span>
          </td>
          <td class="px-3 py-2 text-sm text-gray-600">{{ payment.payment_method || '—' }}</td>
          <td class="px-3 py-2 text-sm text-gray-600">{{ payment.reference_number || '—' }}</td>
          <td class="px-3 py-2">
            <div class="flex gap-1">
              <button
                *ngIf="canMarkAsPaid(payment)"
                (click)="markAsPaid(payment)"
                class="p-1 text-green-600 hover:bg-green-50 rounded transition-colors"
                title="Marcar como Pagado">
                <lucide-icon [img]="Check" [size]="16"></lucide-icon>
              </button>
              <button
                *ngIf="canEdit(payment)"
                (click)="editPayment(payment)"
                class="p-1 text-blue-600 hover:bg-blue-50 rounded transition-colors"
                title="Editar">
                <lucide-icon [img]="Edit" [size]="16"></lucide-icon>
              </button>
              <button
                *ngIf="canCancel(payment)"
                (click)="cancelPayment(payment)"
                class="p-1 text-orange-600 hover:bg-orange-50 rounded transition-colors"
                title="Cancelar">
                <lucide-icon [img]="X" [size]="16"></lucide-icon>
              </button>
              <button
                *ngIf="canDelete(payment)"
                (click)="deletePayment(payment)"
                class="p-1 text-red-600 hover:bg-red-50 rounded transition-colors"
                title="Eliminar">
                <lucide-icon [img]="Trash2" [size]="16"></lucide-icon>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
