<div class="flex flex-col h-full">
  <!-- Header -->
  <div class="p-6 border-b border-gray-200">
    <div class="flex items-start justify-between gap-4">
      <div class="flex-1 min-w-0">
        <h3 class="text-xl font-semibold text-gray-900">
          {{ user.first_name || user.name || 'N/A' }} {{ user.last_name || '' }}
        </h3>
        <p class="text-sm text-gray-600 mt-1 truncate" [title]="user.email">{{ user.email }}</p>
      </div>
      <app-button
        text="Editar"
        size="sm"
        custom_class="btn_primary"
        (clicked)="openEditDialog()">
      </app-button>
    </div>
  </div>

  <!-- Content -->
  <div class="flex-1 overflow-y-auto p-6">
    <div class="space-y-6">
      <!-- User Info Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- First Name -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Nombre</label>
          <p class="mt-1 text-sm text-gray-900">{{ user.first_name || 'N/A' }}</p>
        </div>

        <!-- Last Name -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Apellido</label>
          <p class="mt-1 text-sm text-gray-900">{{ user.last_name || 'N/A' }}</p>
        </div>

        <!-- Email -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Email</label>
          <p class="mt-1 text-sm text-gray-900 truncate" [title]="user.email">{{ user.email }}</p>
        </div>

        <!-- Phone -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Teléfono</label>
          <p class="mt-1 text-sm text-gray-900">{{ user.phone || 'N/A' }}</p>
        </div>

        <!-- Status -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Estado</label>
          <p class="mt-1">
            <span
              [class]="getStatusBadgeClass(getNormalizedStatus(user.status))"
              class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium"
            >
              {{ getNormalizedStatus(user.status) | titlecase }}
            </span>
          </p>
        </div>

        <!-- Created At -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Creado</label>
          <p class="mt-1 text-sm text-gray-900">
            {{ user.createdAt | date: 'MMM d, y' }}
          </p>
        </div>

        <!-- Tenant ID -->
        <div>
          <label class="block text-sm font-medium text-gray-700">ID del Tenant</label>
          <p class="mt-1 text-sm text-gray-900 break-all">{{ user.tenant_id || 'N/A' }}</p>
        </div>

        <!-- Last Login -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Último Acceso</label>
          <p class="mt-1 text-sm text-gray-900">
            {{ user.last_login_at ? (user.last_login_at | date: 'MMM d, y') : 'Nunca' }}
          </p>
        </div>
      </div>

      <!-- Divider -->
      <div class="border-t border-gray-200"></div>

      <!-- Assign New Role Section -->
      <div>
        <h4 class="text-sm font-medium text-gray-900 mb-4">Asignar Nuevo Rol</h4>
        @if (availableRoles$ | async; as availableRoles) {
          <div class="flex gap-2">
            <div class="flex-1">
              <app-select
                [config]="assignRoleSelectConfig"
                (changeOption)="onRoleAssignmentChange($event)"
                [attr.data-testid]="'assign-role-select'"
              ></app-select>
            </div>
            <app-button
              text="Agregar Rol"
              variant="primary"
              size="md"
              [fullWidth]="false"
              [disabled]="!(selectedRoleIdForAssignment$ | async)"
              (clicked)="confirmRoleAssignment()"
              [attr.data-testid]="'confirm-assign-role-btn'"
            ></app-button>
          </div>
        }
      </div>

      <!-- Divider -->
      <div class="border-t border-gray-200"></div>

      <!-- Current Roles Section -->
      <div>
        <h4 class="text-sm font-medium text-gray-900 mb-4">Roles Actuales</h4>
        
        <!-- Loading State -->
        @if (isLoadingRoles$ | async) {
          <div class="flex items-center justify-center p-8">
            <div class="flex flex-col items-center gap-3">
              <div class="w-8 h-8 border-4 border-gray-200 border-t-blue-600 rounded-full animate-spin"></div>
              <p class="text-sm text-gray-600">Cargando roles...</p>
            </div>
          </div>
        } @else {
          <!-- No Roles Message -->
          @if (userRoles$ | async; as roles) {
            @if (roles.length === 0) {
              <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                <p class="text-sm text-gray-600">No hay roles asignados</p>
              </div>
            } @else {
              <!-- Roles List -->
              <div class="space-y-3">
                @for (role of roles; track role.id) {
                  <div
                    class="p-4 bg-gray-50 rounded-lg border border-gray-200"
                    [attr.data-testid]="'role-item-' + role.id"
                  >
                    <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                      <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900">{{ role.name }}</p>
                        <p class="text-xs text-gray-600 mt-1">
                          {{ role.permissions.length }} permiso{{ role.permissions.length !== 1 ? 's' : '' }}
                        </p>
                        <p class="text-xs text-gray-500 mt-2 wrap-break-word">{{ role.description }}</p>
                      </div>
                      <!-- Action Buttons -->
                      <div class="flex gap-2 shrink-0">
                        <!-- Replace Role Button -->
                        @if (availableRoles$ | async; as availableRoles) {
                          <app-button
                            text="Reemplazar"
                            variant="secondary"
                            size="sm"
                            [fullWidth]="false"
                            (clicked)="openRoleReplacementDropdown(role.id)"
                            [attr.data-testid]="'replace-role-btn-' + role.id"
                          ></app-button>
                        }
                        <!-- Delete Role Button -->
                        <app-button
                          text="Eliminar"
                          variant="danger"
                          size="sm"
                          [fullWidth]="false"
                          (clicked)="deleteRoleFromUser(role.id)"
                          [attr.data-testid]="'delete-role-btn-' + role.id"
                        ></app-button>
                      </div>
                    </div>
                  </div>
                }
              </div>
            }
          }
        }
      </div>

      <!-- Role Replacement Dropdown (Hidden) -->
      @if (showRoleReplacementDropdown$ | async) {
        <div class="mt-4">
          <h4 class="text-sm font-medium text-gray-900 mb-4">Selecciona Nuevo Rol</h4>
          @if (availableRoles$ | async; as availableRoles) {
            <app-select
              [config]="replaceRoleSelectConfig"
              (changeOption)="onRoleReplacementChange($event)"
              [attr.data-testid]="'replace-role-select'"
            ></app-select>
          }
        </div>
      }
    </div>
  </div>
</div>
