import{i as oe,j as re,k as ie}from"./chunk-WEYOGA7X.js";import{a as te}from"./chunk-SJ2MQSEX.js";import{c as Y,d as Z,e as ee,k as ne}from"./chunk-OANT22MG.js";import{c as h,f as q,g as z,l as U,q as J,s as K,t as Q,v as W}from"./chunk-MQV4I3IR.js";import{A as X,B as y,y as B,z as V}from"./chunk-PIG46PEF.js";import{A as L,m as _,t as b,y as H}from"./chunk-66A2AKCP.js";import{Ab as r,Bb as p,Cb as l,Db as T,F as N,L as F,M as k,Ob as g,Q as C,Qa as n,U as d,Za as a,c as D,cc as I,d as O,db as v,dc as R,e as w,ga as x,j as P,la as f,m as A,ra as $,x as j}from"./chunk-56XCPM73.js";import{a as u,b as m}from"./chunk-7CGTOI24.js";var G=class i{constructor(e){this.http=e}api=y.api;groupsCache=null;cacheExpiry=0;CACHE_DURATION=300*1e3;groupsSubject=new w([]);groups$=this.groupsSubject.asObservable();fetchGroups(){return this.groupsCache&&Date.now()<this.cacheExpiry?new D(e=>{e.next(this.groupsCache),e.complete()}):this.http.get(`${this.api}/tenant/customer-groups`).pipe(N(2),k(e=>{let t=Array.isArray(e)?e:e.groups||[];this.groupsCache=t,this.cacheExpiry=Date.now()+this.CACHE_DURATION,this.groupsSubject.next(t)}),A(e=>Array.isArray(e)?e:e.groups||[]),j(e=>{console.error("Error fetching customer groups:",e);let t="Failed to fetch groups. Please try again.",o="network";return e.status>=500?(t="Error del servidor. Por favor, intenta m\xE1s tarde.",o="server"):e.status>=400?(t="Error de validaci\xF3n. Por favor, verifica los datos.",o="validation"):e.status===0&&(t="No se puede conectar. Por favor, verifica tu conexi\xF3n a internet.",o="network"),P(()=>({type:o,message:t,originalError:e}))}))}invalidateCache(){this.groupsCache=null,this.cacheExpiry=0}getCachedGroups(){return this.groupsCache||[]}static \u0275fac=function(t){return new(t||i)(d(b))};static \u0275prov=C({token:i,factory:i.\u0275fac,providedIn:"root"})};var M=class i{constructor(e){this.groupFetchService=e}selectedGroupId=null;disabled=!1;groupSelect=new x;groups=[];groupControl=new z(null);selectConfig={placeholder:"Filtrar por grupo",data:[],value:"id",option:"name",all:!0,all_message:"Ver Todos",form_control:this.groupControl,loading:!0};isLoadingGroups=!1;groupsError=null;destroy$=new O;ngOnInit(){this.loadGroups()}ngOnChanges(e){e.selectedGroupId&&this.groupControl&&this.groupControl.setValue(this.selectedGroupId,{emitEvent:!1})}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}loadGroups(){this.isLoadingGroups=!0,this.groupsError=null,this.groupFetchService.fetchGroups().pipe(F(this.destroy$)).subscribe({next:e=>{this.groups=e,this.selectConfig=m(u({},this.selectConfig),{data:e.map(t=>({id:t.id,name:t.name,customer_count:t.customer_count||0})),loading:!1}),this.selectedGroupId&&this.groupControl.setValue(this.selectedGroupId,{emitEvent:!1}),this.isLoadingGroups=!1},error:e=>{this.isLoadingGroups=!1,this.selectConfig=m(u({},this.selectConfig),{loading:!1}),this.groupsError=e,console.error("Error loading groups:",e)}})}onGroupChange(e){let t=e.value,s=this.groups.find(c=>c.id===t)?.name||null;this.groupSelect.emit({groupId:t,groupName:s})}static \u0275fac=function(t){return new(t||i)(a(G))};static \u0275cmp=v({type:i,selectors:[["app-customer-group-dropdown"]],inputs:{selectedGroupId:"selectedGroupId",disabled:"disabled"},outputs:{groupSelect:"groupSelect"},features:[$],decls:1,vars:2,consts:[[3,"changeOption","config","disable"]],template:function(t,o){t&1&&(p(0,"app-select",0),g("changeOption",function(c){return o.onGroupChange(c)}),l()),t&2&&r("config",o.selectConfig)("disable",o.isLoadingGroups||!!o.groupsError||o.disabled)},dependencies:[_,te],encapsulation:2})};var S=class i{constructor(e,t,o){this.router=e;this.http=t;this.activated_route=o}api=y.api;getCustomers(e){return this.http.get(`${this.api}/tenant/customers`,{params:e})}getCustomer(e){return this.http.get(`${this.api}/tenant/customers/${e}`)}getCustomerAddresses(e){return this.http.get(`${this.api}/tenant/customers/${e}/addresses`)}getCustomerActivities(e,t=1,o=10){return this.http.get(`${this.api}/tenant/customers/${e}/activities`,{params:{page:t,limit:o}})}updateCustomer(e,t){return this.http.put(`${this.api}/tenant/customers/${e}`,t)}createCustomer(e){return this.http.post(`${this.api}/tenant/customers`,e)}static \u0275fac=function(t){return new(t||i)(d(L),d(b),d(H))};static \u0275prov=C({token:i,factory:i.\u0275fac,providedIn:"root"})};var se=class i{constructor(e,t,o,s,c,me){this.fb=e;this.dialog=t;this.dialog_ref=o;this.data=s;this.customerService=c;this.interceptor_service=me;if(this.form=this.fb.group({name:["",[h.required]],lastname:[""],email:["",[h.required,h.email]],phone:[""],phone_code:["+52",[h.required]],phone_country:["MX",[h.required]],company_name:[""]}),this.data?.customer){this.isCreateMode.set(!1);let ae=this.data.customer.phone?.replace(/\D/g,"").slice(-10)||"";this.form.patchValue({name:this.data.customer.name,lastname:this.data.customer.lastname||"",email:this.data.customer.email,phone:ae,phone_code:this.data.customer.phone_code||"+52",phone_country:this.data.customer.phone_country||"MX",company_name:this.data.customer.company_name||""}),this.selectedGroup.set(this.data.customer.group||null)}else this.isCreateMode.set(!0)}loading=f(!1);update=f(!1);selectedGroup=f(null);isCreateMode=f(!1);X=B;form;onGroupSelected(e){this.selectedGroup.set(e.groupId?{id:e.groupId,name:e.groupName}:null)}get phoneCodeControl(){return this.form.get("phone_code")}get phoneCountryControl(){return this.form.get("phone_country")}getPhoneCodeControl(){return this.form.get("phone_code")}getPhoneCountryControl(){return this.form.get("phone_country")}closeDialog(){this.loading()||this.dialog_ref.close(this.update())}submit(){this.isCreateMode()?this.createCustomer():this.updateCustomer()}createCustomer(){if(this.form.invalid){this.form.markAllAsTouched();return}this.loading.set(!0);let e=m(u({},this.form.value),{group_id:this.selectedGroup()?.id||null});this.customerService.createCustomer(e).subscribe({next:()=>{this.update.set(!0),this.loading.set(!1),this.interceptor_service.openSnackbar({type:"success",title:"\xC9xito",message:"Cliente creado correctamente."}),this.closeDialog()},error:()=>{this.loading.set(!1),this.interceptor_service.openSnackbar({type:"error",title:"Error",message:"No pudimos crear el cliente. Por favor intenta de nuevo."})}})}updateCustomer(){if(this.form.invalid){this.form.markAllAsTouched();return}this.loading.set(!0);let e=m(u(u({},this.data.customer),this.form.value),{group_id:this.selectedGroup()?.id||null});this.customerService.updateCustomer(e.id,e).subscribe({next:()=>{this.update.set(!0),this.loading.set(!1),this.interceptor_service.openSnackbar({type:"success",title:"\xC9xito",message:"Cliente actualizado correctamente."}),this.closeDialog()},error:()=>{this.loading.set(!1),this.interceptor_service.openSnackbar({type:"error",title:"Error",message:"No pudimos actualizar el cliente. Por favor intenta de nuevo."})}})}static \u0275fac=function(t){return new(t||i)(a(J),a(ee),a(Y),a(Z),a(S),a(ne))};static \u0275cmp=v({type:i,selectors:[["app-customer-edit-modal"]],decls:20,vars:14,consts:[[1,"dialog"],[1,"dialog__header"],[1,"close","cursor-pointer",3,"click","img"],[1,"dialog__body"],[1,"container","grid","grid-cols-1","md:grid-cols-2","gap-4",3,"formGroup"],["label","Nombre",3,"form_control"],["label","Apellido",3,"form_control"],["label","Email",3,"form_control"],["label","Tel\xE9fono","appPhoneDigits","",3,"form_control"],[3,"control"],["label","Empresa",3,"form_control"],[1,"md:col-span-2"],[1,"block","text-sm","font-medium","text-gray-700","mb-1"],[3,"groupSelect","selectedGroupId","disabled"],[1,"dialog__footer"],["custom_class","btn_primary",3,"clicked","text","loading"]],template:function(t,o){if(t&1&&(p(0,"div",0)(1,"div",1)(2,"h2"),I(3),l(),p(4,"lucide-icon",2),g("click",function(){return o.closeDialog()}),l()(),p(5,"div",3)(6,"div",4),T(7,"app-input",5)(8,"app-input",6)(9,"app-input",7)(10,"app-input",8)(11,"app-phone-code-select",9)(12,"app-phone-country-select",9)(13,"app-input",10),p(14,"div",11)(15,"label",12),I(16,"Grupo"),l(),p(17,"app-customer-group-dropdown",13),g("groupSelect",function(c){return o.onGroupSelected(c)}),l()()()(),p(18,"div",14)(19,"app-button",15),g("clicked",function(){return o.submit()}),l()()()),t&2){let s;n(3),R(o.isCreateMode()?"Crear Cliente":"Editar Cliente"),n(),r("img",o.X),n(2),r("formGroup",o.form),n(),r("form_control",o.form.controls.name),n(),r("form_control",o.form.controls.lastname),n(),r("form_control",o.form.controls.email),n(),r("form_control",o.form.controls.phone),n(),r("control",o.getPhoneCodeControl()),n(),r("control",o.getPhoneCountryControl()),n(),r("form_control",o.form.controls.company_name),n(4),r("selectedGroupId",((s=o.selectedGroup())==null?null:s.id)||null)("disabled",o.loading()),n(2),r("text",o.isCreateMode()?"Crear":"Actualizar")("loading",o.loading())}},dependencies:[_,K,q,U,Q,W,X,V,M,oe,re,ie],styles:[".dialog[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1.5rem;padding:1.5rem;min-width:500px}.dialog__header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;gap:1rem}.dialog__header[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0;font-size:1.25rem;font-weight:600;color:#1f2937}.dialog__header[_ngcontent-%COMP%]   .close[_ngcontent-%COMP%]{width:24px;height:24px;cursor:pointer;color:#6b7280;transition:color .2s ease}.dialog__header[_ngcontent-%COMP%]   .close[_ngcontent-%COMP%]:hover{color:#1f2937}.dialog__body[_ngcontent-%COMP%]{flex:1}.dialog__footer[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:.75rem;padding-top:1rem;border-top:1px solid #e5e7eb}.container[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem}@media(max-width:640px){.dialog[_ngcontent-%COMP%]{min-width:auto;width:100%}}"]})};export{M as a,S as b,se as c};
